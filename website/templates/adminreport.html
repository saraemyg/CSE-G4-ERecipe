<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Reports</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="user-profile-sidebar">
                <img src="https://i.pinimg.com/736x/66/d1/9b/66d19b58cb787b236acfc999b422c40a.jpg" alt="Profile" class="user-profile-pic">
            </div>
            <nav>
                <ul>
                    <li><a href="{{ url_for('adminhome') }}">Dashboard</a></li>
                    <li><a href="{{ url_for('notifications') }}">Notifications</a></li>
                    <li><a href="{{ url_for('reports') }}" class="active">Reports</a></li>
                    <li><a href="{{ url_for('manage') }}">Manage</a></li>
                    <li><a href="{{ url_for('main') }}">Logout</a></li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">

            <div class="content-header">
                <h1>Reports</h1>
                <div class="search-section">
                    <input type="text" id="searchBar" placeholder="Search..." onkeyup="filterContent()">
                    <img id="searchButton" src="https://i.pinimg.com/736x/36/16/e3/3616e36e83edc6b2404204491ceb1c77.jpg" alt="Search" onclick="filterContent()">
                    <select id="contentSelector" class="content-selector" onchange="toggleContent()">
                        <option value="all">Show All</option>
                        <option value="users">Show Users</option>
                        <option value="recipes">Show Recipes</option>
                    </select>
                </div>
            </div>
            
            <section class="dashboard-content">

                <div class="card" id="ReportListCard">
                    <h3 class="card-title">All Reports</h3>
                    <div class="card-list" id = "reportList">
                        {% if reports %}
                            {% for report in reports %}
                            <div class="card-item" data-title="Report #{{ report['reportDetails'] }}" onclick="viewReportDetails('{{ report.reportID}}')">
                                <div class="card-header">
                                    <span class="card-id">#{{ report['reportID'] }}</span>
                                    <span class="card-status {{ report['reportStatus'] }}">{{ report['reportStatus'] }}</span>
                                </div>
                                <p class="card-details">{{ report['reportDetails'] }}</p>
                                <div class="card-footer">
                                    <span class="card-time">{{ report['reportTime'] }}</span>
                                    <span class="card-reference">Recipe #{{ report['reportedRecipeID'] }}</span>
                                    <form action="{{ url_for('update_report_status', id=report['reportID']) }}" method="POST" class="status-form">
                                        <select name="status" onchange="this.form.submit()">
                                            <option value="pending" {% if report['reportStatus'] == 'pending' %}selected{% endif %}>Pending</option>
                                            <option value="resolved" {% if report['reportStatus'] == 'resolved' %}selected{% endif %}>Resolved</option>
                                            <option value="dismissed" {% if report['reportStatus'] == 'dismissed' %}selected{% endif %}>Dismissed</option>
                                        </select>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p>No reports available</p>
                        {% endif %}
                    </div>
                </div>
   
                <div class="card-view hidden" id="viewReportCard">
                    <button class="close-button" onclick="closeReportDetails()">x</button>
                    <div class="card-header">
                        <span id="reportId" class="card-id"></span>
                        <span id="reportStatus" class="card-status"></span>
                    </div>
                    <p id="reportDetails" class="card-details"></p>
                    <div class="card-footer">
                        <span id="reportTime" class="card-time"></span>
                        <span id="reportedRecipeId" class="card-reference"></span>
                        <p id="reportSenderUser" class="card-reference"></p>
                        <p id="reportedUser" class="card-reference"></p>
                        <form id="statusForm" class="status-form">
                            <select name="status" id="statusSelect">
                                <option value="pending">Pending</option>
                                <option value="resolved">Resolved</option>
                                <option value="dismissed">Dismissed</option>
                            </select>
                        </form>
                    </div>
                </div>

            </section>
        </div>
    </div>
    <script>

        function filterContent() {
            const searchInput = document.getElementById('searchBar').value.toLowerCase();
            const reportItems = document.getElementById('reportList').getElementsByClassName('card-item');

            Array.from(reportItems).forEach(item => {
                item.style.display = item.getAttribute('data-title').toLowerCase().includes(searchInput) ? '' : 'none';
            });
        }


        function viewReportDetails(reportID) {
            document.getElementById('ReportListCard').classList.add('hidden');
            const viewReportCard = document.getElementById('viewReportCard');
            viewReportCard.classList.remove('hidden');

            fetch(`/report/${reportID}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('reportId').innerText = `#${data.reportID}`;
                    document.getElementById('reportDetails').innerText = `${data.reportDetails}`;
                    document.getElementById('reportStatus').innerText = `${data.reportStatus}`;
                    document.getElementById('reportTime').innerText = `${data.reportTime}`;
                    document.getElementById('reportedRecipeId').innerText = `Recipe: ${data.relatedRecipe}`;
                    document.getElementById('reportSenderUser').innerText = `Reported By: ${data.reportSenderUser}`;
                    document.getElementById('reportedUser').innerText = `Against: ${data.reportedUser}`;
                    document.getElementById('statusSelect').value = data.reportStatus;

                    document.getElementById('statusForm').onsubmit = function (e) {
                        e.preventDefault();
                        fetch(`/update_report_status/${data.reportID}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: document.getElementById('statusSelect').value })
                        }).then(() => closeReportDetails());
                    };
                })
                .catch(() => {
                    viewReportCard.innerHTML = '<p>Error fetching report details.</p>';
                });
        }

        function closeReportDetails() {
            document.getElementById('viewReportCard').classList.add('hidden');
            document.getElementById('ReportListCard').classList.remove('hidden');
            toggleContent(true);
        }



    </script>

</body>
</html>